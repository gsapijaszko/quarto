{
  "hash": "2184f9cb3636392882b14678bd319e25",
  "result": {
    "markdown": "---\ntitle: \"Cycling infrastructure in the town\"\nsubtitle: \"Mapping with OpenStreetMap\"\nauthor: \"Grzegorz Sapijaszko\"\ndate: \"2022-12-18\"\ncategories: [cycling, OSM, openstreetmap, R]\nbibliography: ../../references.bib\n# image: \"image.jpg\"\ndraft: false\n---\n\n::: {.cell}\n\n:::\n\n\nAnother post inspired by questions on SE, see [here](https://opendata.stackexchange.com/questions/20261/cycling-infrastracture-per-city-in-europe) or [here](https://stackoverflow.com/questions/74487471/map-osmdata-cycleways-in-r-how-to-include-cyclosm-cycleways/74488879#74488879). And great opportunity to explore tagging of bicycle related features in OpenStreetMap. An example based on Wrocław, medium size (680 000 inhabitants) town in south-west part of Poland.\n\n## Highways and tracks\n\nIn OpenStreetMap data the roads designated for bicycle can be described in different ways. The lanes can be separate, can be part of general highway, or shared with pedestrians (and in some countries even with other vehicles). Let's have a quick overview of the used tags.\n\n::: {.callout-warning}\nThis is non exhaustive list of all possible tags which can be used. For more information see wiki description of [cycleway](https://wiki.openstreetmap.org/wiki/Key:cycleway) and [bicycle infrastructure](https://wiki.openstreetmap.org/wiki/Bicycle).\n:::\n\nSeparate ways for cycling usually are described as `highway = cycleway`, and in the field they are marked with white bicycle on blue background sign.[^1]\n\n[^1]: All signs shared from Wikimedia commons. For similar signs in other European countries have a look on [Comparison of European road signs](https://en.wikipedia.org/wiki/Comparison_of_European_road_signs).\n\n```\nhighway = cycleway\n```\n\n::: column-margin\n![](https://upload.wikimedia.org/wikipedia/commons/3/30/PL_road_sign_C-13.svg){width=\"50px\"}\n:::\n\nIf the cycling lane is shared with pedestrians, the usual tagging is:\n\n```\nhighway = footway | path\nbicycle = designated\nfoot = designated\n```\n::: column-margin\n![](https://upload.wikimedia.org/wikipedia/commons/e/ee/PL_road_sign_C-13-16.svg){width=\"50px\"} ![](https://upload.wikimedia.org/wikipedia/commons/2/2e/PL_road_sign_C-13-16a.svg){width=\"50px\"}\n:::\n\nAnother possibility is to share the lane with cars on any highway (primary, tertiary, residential, etc). It can be the lane in the same or opposite direction. Tagging\n\n```\nhighway = *\ncycleway = lane\n```\n\n::: column-margin\n![](https://upload.wikimedia.org/wikipedia/commons/1/13/PL_road_sign_F-19.svg){height=\"50px\"}\n\n![](https://upload.wikimedia.org/wikipedia/commons/c/c8/Znak_B-2+T-22.png){height=\"50px\"}  ![](https://upload.wikimedia.org/wikipedia/commons/e/e2/Znak_D-3+T-22.png){height=\"50px\"}\n:::\n\nis used to tag two-way streets where there are cycle lanes on both sides of the road, or one-way streets where the lane operating in the same direction as main traffic flow. `cycleway = opposite_lane` is used for contraflow; `cycleway = opposite` + `oneway:bicycle = no` where cyclist are permitted to travel in both direction on one-way street. For shared lanes with motor vehicles: `cycleway = shared_lane` and `cycleway=share_busway` with buses. For more specific tagging please check [OpenStreetMap wiki page](https://wiki.openstreetmap.org/wiki/Key:cycleway).\n\nIn some countries additional tagging is in use. `highway = *` + `bicycle_road = yes` for signed roads and `cyclestreet = yes` for roads where other vehicles are allowed.[^2]\n\n[^2]: For details see [Key:bicycle_road](https://wiki.openstreetmap.org/wiki/Key:bicycle_road)\n\n::: column-margin\n![](https://upload.wikimedia.org/wikipedia/commons/4/4e/Zeichen_244.3_-_Beginn_einer_Fahrradzone,_StVO_2020.svg){width=\"50px\"}\n:::\n\n## Other features\n\nBicycle shops are tagged with `shop = bicycle`, and those which provide additional repair services have `service:bicycle:pair = yes` tags. There might be a do-it-yourself service stations, equipped with pump, wrenches and other helpful tools --- in such case they are tagged with `amenity = bicycle_repair_station`. \n\nBicycle parkings are tagged with `amenity = bicycle_parking`. In towns where you can rent a bike, you will find `amenity = bicycle_rental` tags.\n\n## Bicycle routes\n\n> Cycle routes or bicycle route are named or numbered or otherwise signed routes. May go along roads, trails or dedicated cycle paths.[^3] \n\n[^3]: [https://wiki.openstreetmap.org/wiki/Cycle_routes](https://wiki.openstreetmap.org/wiki/Cycle_routes)\n\nThey are tagged as a relations (several features grouped together with relation roles assigned)[^4]; they can be of different network levels: `network = icn | ncn | rcn | lcn` which corresponds to international route, a national route, a regional route or a local route. Below an example of tagging of Polish part of EuroVelo 9 route, which crosses Wrocław:\n\n    type = route\n    route = bicycle\n    network = icn\n    ref = EV9\n    colour = green\n    icn_ref = 9\n    \n[^4]: [https://wiki.openstreetmap.org/wiki/Relation](https://wiki.openstreetmap.org/wiki/Relation)\n\nAs we already know and understand the attributes of the data, let's play with it a bit. In next paragraph we will assess quantitatively the bicycle infrastructure in Wrocław.\n\n## Wrocław's infrastructure\n\nFor data access/download we will use `osmdata` package [@osmdata2017; @R-osmdata]. We will download town boundary, highways and other bicycle infrastructure. We will save the data for further reuse.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nget_osm_data <- function(place, feature, output_dir = \"data\") {\n  output_dir = paste0({{output_dir}}, \"/\", iconv(place, to=\"ASCII//TRANSLIT\"))\n  if(!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)\n  data_file = paste0(output_dir, \"/\", feature, \".rds\")\n  if(!file.exists(data_file)) {\n    \n    bb <- osmdata::getbb(place, featuretype = \"city\")\n    switch(feature,\n           boundary = {\n             message(paste(\"Downloading boundary for\", place))\n             osm_data <-osmdata::opq(bb, timeout = 25*100) |>\n               osmdata::add_osm_feature(key = \"boundary\", value = \"administrative\") |> \n               osmdata::add_osm_feature(key = \"admin_level\", value = \"6\") |> \n               osmdata::osmdata_sf() |>\n               osmdata::unique_osmdata()\n             saveRDS(osm_data, file = data_file)\n           },\n           highway = {\n             message(paste(\"Downloading highways for\", place))\n             osm_data <-osmdata::opq(bb, timeout = 25*100) |>\n               osmdata::add_osm_features(features = c(\"\\\"highway\\\"\", \"\\\"cycleway\\\"\")) |> \n               osmdata::osmdata_sf() |>\n               osmdata::unique_osmdata()\n             saveRDS(osm_data, file = data_file)\n           },\n           bicycle = {\n             message(paste(\"Downloading bicycle infrastructure for\", place))\n             osm_data <-osmdata::opq(bb, timeout = 25*100) |>\n               osmdata::add_osm_feature(key = \"bicycle\") |> \n               osmdata::osmdata_sf() |>\n               osmdata::unique_osmdata()\n             saveRDS(osm_data, file = data_file)\n           }\n        )\n  } else {\n    message(paste(\"File\", data_file, \"already exists\"))\n  }\n}\n\nfeatures <- list(\"boundary\", \"highway\", \"bicycle\")\nlapply(seq_along(features), function(i) get_osm_data(\"Wrocław\", features[[i]], output_dir = \"data\"))\n```\n:::\n\n\nHaving the data downloaded we can start our analysis. As first step we will create Wrocław's boundary as `sf` polygon, it will be used to crop remaining data sets to city limits.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntb <- readRDS(\"data/Wroclaw/boundary.rds\")\ntb <- tb$osm_multipolygons |>\n  subset(name == \"Wrocław\") |>\n  subset(select = c(\"name\", \"geometry\")) |>\n  sf::st_as_sf()\nsf::write_sf(tb, dsn = \"data/wroclaw.gpkg\", layer = \"boundary\", delete_layer = TRUE)\n```\n:::\n\n\nHighways and cycleways. As they might be returned from Overpass query as `osm_lines` and `osm_multilines` we have to bind them together.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhighways <- readRDS(\"data/Wroclaw/highway.rds\")\n  hw <- highways$osm_lines |>\n    dplyr::select(\"osm_id\", \"name\", \"highway\", \"bicycle\",\n                  \"foot\", starts_with(c(\"cycleway\")), \"oneway\", \n                  \"surface\", \"vehicle\")\n  if(!is.null(highways$osm_multilines)) {\n    multilines <- highways$osm_multilines |>\n      dplyr::select(\"osm_id\", \"name\", \"highway\", \"bicycle\",\n                    \"foot\", starts_with(c(\"cycleway\")), \"oneway\",\n                    \"surface\", \"vehicle\")\n    hw <- rbind(hw, multilines) |>\n      sf::st_as_sf()\n  }\nhw <- suppressWarnings(sf::st_intersection(hw, tb))\nsf::write_sf(hw, dsn = \"data/wroclaw.gpkg\", layer = \"highways\", delete_layer = TRUE)\n```\n:::\n\n\nWith the highways prepared, let's run simple analysis: count the length of the roads for bikes, bikes + pedestrians, and cars only.\n\n### Bike only\n\n\n::: {.cell}\n\n```{.r .cell-code}\nddr <- hw |>\n  dplyr::filter(highway == \"cycleway\" | cycleway %in% c(\"lane\", \"track\", \"yes\")) |>\n  dplyr::summarise(geometry = sf::st_union(geometry)) |>\n  dplyr::mutate(length = units::set_units(sf::st_length(geometry), \"km\")) |>\n  dplyr::mutate(category = \"Bikes only\") |>\n  sf::st_drop_geometry()\n```\n:::\n\n\nVery similar approach for other categories.\n\n\n::: {#tbl-summary_length .cell tbl-cap='Summary of lenth of bike, shared with pedestrians, and cars roads in Wrocław'}\n\n```{.r .cell-code  code-fold=\"true\"}\nddrip <- hw |>\n  dplyr::filter(highway %in% c(\"path\", \"footway\")) |>\n  dplyr::filter(bicycle == \"designated\") |>\n  dplyr::summarise(geometry = sf::st_union(geometry)) |>\n  dplyr::mutate(length = units::set_units(sf::st_length(geometry), \"km\")) |>\n  dplyr::mutate(category = \"Bikes + Pedestrians\") |>\n  sf::st_drop_geometry()\n\ncars_only <- hw |>\n  dplyr::filter(!highway %in% c(\"cycleway\", \"path\", \"footway\")) |>\n  dplyr::filter(is.na(cycleway.left) | is.na(cycleway.right)) |>\n  dplyr::summarise(geometry = sf::st_union(geometry)) |>\n  dplyr::mutate(length = units::set_units(sf::st_length(geometry), \"km\")) |>\n  dplyr::mutate(category = \"Cars only\") |>\n  sf::st_drop_geometry()\n\n#' and let's bind them together\n\nddr |>\n  rbind(ddrip) |>\n  rbind(cars_only) |>\n  dplyr::mutate(l = \"Total length\") |>\n  tidyr::pivot_wider(names_from = category, values_from = length) |>\n  dplyr::mutate(across(2:4, ~format(round(.x, 1), nsmall = 1))) |>\n  kableExtra::kbl(booktabs = TRUE, escape = F, linesep = \"\",\n    col.names = kableExtra::linebreak(c(\"\", \"Bikes only\", \"Bikes + Pedestrians\", \"Cars only\"), align = \"c\"),\n    align = c(\"crrr\")) |>\n  kableExtra::kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\">  </th>\n   <th style=\"text-align:right;\"> Bikes only </th>\n   <th style=\"text-align:right;\"> Bikes + Pedestrians </th>\n   <th style=\"text-align:right;\"> Cars only </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> Total length </td>\n   <td style=\"text-align:right;\"> 135.7 [km] </td>\n   <td style=\"text-align:right;\"> 213.9 [km] </td>\n   <td style=\"text-align:right;\"> 3717.6 [km] </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNot much, as for 680k inhabitants town, around 0.5 km per 1000 ppl. And less than 10% in comparison to cars road network...\n\nIf you would like to split it by surface (asphalt, concrete, etc), then we can just group our highways by that column, like\n\n\n::: {.cell}\n\n```{.r .cell-code}\nddr <- hw |>\n  dplyr::filter(highway == \"cycleway\" | cycleway %in% c(\"lane\", \"track\", \"yes\")) |>\n  dplyr::group_by(surface) |>\n  dplyr::summarise(geometry = sf::st_union(geometry)) |>\n  [...]\n```\n:::\n\n\nWhich gives:\n\n::: {#tbl-bike_only_by_surface .cell tbl-cap='Length of bike only roads by surface'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Surface </th>\n   <th style=\"text-align:right;\"> Length [km] </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> asphalt </td>\n   <td style=\"text-align:right;\"> 96.14 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> paving_stones </td>\n   <td style=\"text-align:right;\"> 23.66 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:right;\"> 12.76 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> paved </td>\n   <td style=\"text-align:right;\"> 0.91 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> concrete </td>\n   <td style=\"text-align:right;\"> 0.76 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> sett </td>\n   <td style=\"text-align:right;\"> 0.73 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> unpaved </td>\n   <td style=\"text-align:right;\"> 0.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> compacted </td>\n   <td style=\"text-align:right;\"> 0.23 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dirt </td>\n   <td style=\"text-align:right;\"> 0.18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> concrete:plates </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> fine_gravel </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> metal </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n@fig-plots visualizes road networks and the density of it.\n\n\n::: {#fig-plots .cell .column-page layout-ncol=\"2\"}\n::: {.cell-output-display}\n![Bikes](index_files/figure-html/fig-plots-1.png){#fig-plots-1 width=672}\n:::\n\n::: {.cell-output-display}\n![Cars](index_files/figure-html/fig-plots-2.png){#fig-plots-2 width=672}\n:::\n\nPlots of Wrocław highways\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}