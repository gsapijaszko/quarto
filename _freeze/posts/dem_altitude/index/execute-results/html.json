{
  "hash": "0580d3a2d0ab22ac3bff91ab29685714",
  "result": {
    "markdown": "---\ntitle: \"Where to find altitude for my coordinates?\"\nauthor: \"Grzegorz Sapijaszko\"\ndate: \"2022-10-02\"\ncategories: [R, OpenData, DEM]\nbibliography: ../../references.bib\nimage: \"image.jpg\"\ndraft: false\n---\n\n::: {.cell}\n\n:::\n\n\n## Introduction\n\n<!--\nTopography, or local relief, is one of the main factors controlling processes taking place in the near-surface layer of the Earth, it's also a soil forming factor. Many of the differences in soils that vary with topography are due to combination of microclimate, pedogenesis, and geological processes. Soil properties vary with topography. One reason for this is the orientation of the hill slopes on which soils form; this affects the microclimate, the soil and vegetation in that area. Another is the steepness of the slope; this affects soil properties because the rates of surface-water runoff and erosion vary with slope [@birkelandSoilsGeomorphology1984; @schaetzlSoilsGenesisGeomorphology2005].\n-->\n\n[Looking for a DEM elevation model for entire UK - not in tile form](https://opendata.stackexchange.com/questions/20498/looking-for-a-dem-elevation-model-for-entire-uk-not-in-tile-form) is the query on Open Data StackExchange that prompted this post. The initial question was:\n\n> I need to calculate the elevation of 1600 survey plots covering all of the UK - I have these formatted as a point shapefile. I have looked at the OS50 dataset but this is only available as tiles and it would take forever to process each tile individually - my points cover the entire country. Is there free-to-use raster elevation data anywhere that is not split into many tiles?\n\nLet's review, where to look for Open Source data or what other options we have.\n\n## Sources of data for Digital Terrain Models\n\nOn the global scale there are few sources available, including:\n\n-   SRTM90, SRTM30\n-   TanDEM-X\n\nNasa held the SRTM\\index{SRTM} (Shuttle Radar Topography Mission) in 2000. The first set of data was released in 2005, however the regions outside the United States were sampled at 3 arc-seconds, which is 1/1200th of a degree of latitude and longitude, or roughly 90 meters on equator [@farrShuttleRadarTopography2007]. In 2014 NASA released brand-new dataset with a resolution of 1 arc-second, or roughly 30 meters. [Earth Explorer](http://earthexplorer.usgs.gov/) provides the data.\n\nTanDEM-X\\index{TanDEM-X} (TerraSAR-X add-on for Digital Elevation Measurements) data produced by SAR interferometry was acquired in January 2015; the production of the global DEM was completed in September 2016. The absolute height error is with about 1~m. The TanDEM-X 90m DEM publicly available has a pixel spacing of 3 arc-seconds, similar to SRTM90. It covers with 150 Mio sqkm all Earth's landmasses from pole to pole. More information and data available from [EOC Geoservice](https://geoservice.dlr.de/web/dataguide/tdm90/) portal.\n\nFor the Europe, there is a set released by Copernicus Programme named EU-DEM v1.0 (or v1.1) --- it's a digital surface model (DSM)[^1] of European Econemic Area countries. It is a hybrid product based on SRTM and ASTER GDEM data fused by a weighted averaging approach. Detailed description of the dataset and links for download are available under [their portal](https://land.copernicus.eu/imagery-in-situ/eu-dem).\n\n[^1]: Digital Surface Model, not Digital Terrain Model!\n\nAll of the above models are characterized by a spatial resolution of 30/90 meters. If more accurate data is needed, look for national sites, where you can download (or buy) the dataset. A few examples below.\n\n-   Czech Republic: You can find (and buy) Digital Terrain Model of the Czech Republic of the 4th (and 5th) generation on Czech Office for Surveying, Mapping and Cadastre (ČÚZK) portal[^2]. As Open Data it provides Data50 set which has been derived from a cartographic database for Base map CR 1 : 50 000 and it is totally comprised of 8 thematic groups. Data are provided as open data in SHP data format.\n\n-   Germany: Federal Agency for Cartography and Geodesy[^3] provides DEM in 200 m raster (Open Data), however several constituent states provides the data in much better resolution.\n\n-   Slovakia: Geodesy, Cartography and Cadastre Authority of the Slovak Republic (ÚGKK SR) provides access to DTM data through their portal[^4] - you can either order the whole set of data or download a small set at once.\n\n-   Poland: All data available through Head Office of Geodesy and Cartography geoportal.[^5] DEMs are available as rasters of resolution 1 or 5 m (Open Data).\n\n[^2]: <https://geoportal.cuzk.cz/>\n\n[^3]: <https://www.bkg.bund.de>\n\n[^4]: <https://www.geoportal.sk/en/zbgis/als_dmr/>\n\n[^5]: <http://www.geoportal.gov.pl>\n\n## Raster processing\n\nLet's acquire and process the data. For raster manipulation we will use `terra` package [@R-terra], for overall management of spatial features --- package `sf` [@sf2018].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(terra)\nlibrary(sf)\n```\n:::\n\n\n### SRTM\n\nTo download the SRTM rasters we can use one of `elevation_` functions from `geodata` package [@R-geodata].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nele <- geodata::elevation_30s(\"United Kingdom\", path = \"data\")\nterra::plot(ele)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/ele-1.png){width=672}\n:::\n:::\n\n\n`elevation_30s()` function returns an aggregated data with spatial resolution about 1 km (30 arc seconds). The data was prepared based on SRTM 90 m and supplemented with the GTOP30 data for latitudes greater than 60 degrees.\n\n#### Species occurence data\n\nGoing back to original question:\n\n> I need to calculate the elevation of 1600 survey plots covering all of the UK - I have these formatted as a point shapefile.\n\nLet's prepare a sample occurrence data for one of the species in UK from GBIF database using `rgbif` package [@R-rgbif].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nocc <- rgbif::occ_data(\n  scientificName = \"Calystegia pulchra\", \n  country = \"GB\", \n  hasCoordinate = TRUE\n  )\n\nocc <- head(occ$data, 20) |>\n  sf::st_as_sf(coords = c(\"decimalLongitude\", \"decimalLatitude\"), crs = terra::crs(ele)) |>\n  subset(select = c(\"key\", \"scientificName\"))\n```\n:::\n\n\nLet's add the observations to the plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nterra::plot(ele, main = \"Sample of C. pulchra distribution in UK\")\nocc |>\n  sf::st_geometry() |>\n  plot(add = TRUE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/ele_plot-1.png){width=672}\n:::\n:::\n\n\nHaving our sample data prepared, which is class of sf, tbl_df, tbl, data.frame we can add the elevation to the set using `extract()` function form `terra`. Function `extract()` requires an object of class SpatVector\n\n\n::: {.cell}\n\n```{.r .cell-code}\nocc |>\n  dplyr::mutate(elevation = terra::extract(ele, terra::vect(geometry))$GBR_elv_msk) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -6.189535 ymin: 51.49552 xmax: -0.17902 ymax: 57.41207\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 4\n  key        scientificName                                geometry elevation\n  <chr>      <chr>                                      <POINT [°]>     <dbl>\n1 3320924569 Calystegia pulchra Brumm. & Heyw…  (-0.17902 51.49553)        16\n2 3437494613 Calystegia pulchra Brumm. & Heyw… (-1.962333 51.78564)       209\n3 3785877810 Calystegia pulchra Brumm. & Heyw…  (-2.541045 52.5979)       186\n4 3352641836 Calystegia pulchra Brumm. & Heyw… (-6.189535 57.41207)       NaN\n5 3338086543 Calystegia pulchra Brumm. & Heyw… (-2.302697 53.20301)        76\n```\n:::\n:::\n\n\nPoints with no value (`elevation = NaN`) may be caused by inaccuracy or rounding of coordinates when data is anonymized by GBIF. And in fact, if we checked the fourth point, it would turn out to be at sea. All other elevations are given in meters.\n\nLet's try more accurate data, with 3 arcs sec resolution, for UK. Function `elevation_3s(lon, lat, ...)` from `geodata` will help to acquire all necessary tiles. To get the `lon` and `lat` parameters we will download the UK boundaries and check the bounding box.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nuk <- geodata::gadm(\"United Kingdom\", path = \"data\") |>\n  terra::project(terra::crs(ele))\n\nbbox <- sf::st_bbox(uk)\nbbox\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     xmin      ymin      xmax      ymax \n-8.649996 49.865310  1.764393 60.845480 \n```\n:::\n\n```{.r .cell-code}\nfor (x in floor(bbox[1]):ceiling(bbox[3])) {\n  for (y in floor(bbox[2]):ceiling(bbox[4])) {\n    geodata::elevation_3s(lon = x, lat = y, path = \"data\")\n  }\n}\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in geodata::elevation_3s(lon = x, lat = y, path = \"data\"): lat >= -60 & lat <= 60 is not TRUE\n```\n:::\n:::\n\n\nHmm... In fact the boundaries of UK exceed the 60`&#176;`{=html} N, so, let's modify our loop (we sacrificed the Shetland Islands, sorry):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (x in floor(bbox[1]):ceiling(bbox[3])) {\n  for (y in floor(bbox[2]):60) {\n    geodata::elevation_3s(lon = x, lat = y, path = \"data\")\n  }\n}\n```\n:::\n\n\nHaving all files downloaded we can build an virtual raster and work with it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr <- list.files(path = \"data\", pattern = \"srtm_.+.tif\", full.names = TRUE)\nvrt <- terra::vrt(r, \"data/vrt.vrt\", overwrite = TRUE) |>\n  crop(uk) |>\n  mask(uk)\nterra::plot(vrt)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/virtual_srtm-1.png){width=672}\n:::\n:::\n\n\nLet's extract the elevation from our more accurate rasters:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nocc |>\n  dplyr::mutate(ele_30s = terra::extract(ele, terra::vect(geometry))$GBR_elv_msk) |>\n  dplyr::mutate(ele_3s = terra::extract(vrt, terra::vect(geometry))$vrt) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 4 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -6.189535 ymin: 51.49552 xmax: -0.17902 ymax: 57.41207\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 5\n  key        scientificName                         geometry ele_30s ele_3s\n  <chr>      <chr>                               <POINT [°]>   <dbl>  <dbl>\n1 3320924569 Calystegia pulchra Brumm.…  (-0.17902 51.49553)      16     15\n2 3437494613 Calystegia pulchra Brumm.… (-1.962333 51.78564)     209    210\n3 3785877810 Calystegia pulchra Brumm.…  (-2.541045 52.5979)     186    162\n4 3352641836 Calystegia pulchra Brumm.… (-6.189535 57.41207)     NaN    NaN\n5 3338086543 Calystegia pulchra Brumm.… (-2.302697 53.20301)      76     73\n```\n:::\n:::\n\n\nWe got quite similar results regardless of resolution. On the other hand, if the your plots are located in mountainous region --- the higher the raster resolution, the better.\n\n### TanDEM-X\n[The original package is a bit outdated, and you have to change baseurl variable in `download_TanDEM()` function. There is [my fork](https://github.com/gsapijaszko/TanDEM-R) already.]{.aside}\n\nTanDEM data is available from [https://download.geoservice.dlr.de/TDM90/](https://download.geoservice.dlr.de/TDM90/) service. To download the neccessary data we will use `TanDEM` package [@R-TanDEM] available on [GitHub](https://github.com/meteosimon/TanDEM-R).\n\nPlease remember to set up the keyring with your user name, like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkeyring::key_set(service = \"geoservice.dlr\", username = \"grzegorz.sapijaszko@gmail.com\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!dir.exists(\"data/tandem\")) { dir.create(\"data/tandem\") }\nTanDEM::download_TanDEM(\n  lon = c(bbox[1], bbox[3]),\n  lat = c(bbox[2], bbox[4]),\n  usr = \"grzegorz.sapijaszko@gmail.com\",\n  srv = \"geoservice.dlr\",\n  dstdir = \"data/tandem\"\n)\n```\n:::\n\nIn next step we will build virtual raster and assign `NA` for cells with no data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr <- list.files(path = \"data/tandem/\", pattern = \"TDM1_.+.tif\", full.names = TRUE)\ntandem <- terra::vrt(r, \"data/tandem/vrt.vrt\", overwrite = TRUE) \n\nterra::NAflag(tandem) <- -32767\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntandem <- tandem |>\n  terra::mask(uk) |>\n  terra::crop(uk)\nterra::plot(tandem)\n```\n:::\n\n\nFinally, we can extract elevations:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nocc |>\n  dplyr::mutate(ele_tandem = terra::extract(tandem, terra::vect(geometry))$vrt) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -6.189535 ymin: 51.49552 xmax: -0.17902 ymax: 57.41207\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 4\n  key        scientificName                                geometry ele_tandem\n  <chr>      <chr>                                      <POINT [°]>      <dbl>\n1 3320924569 Calystegia pulchra Brumm. & Heyw…  (-0.17902 51.49553)       60.3\n2 3437494613 Calystegia pulchra Brumm. & Heyw… (-1.962333 51.78564)      260. \n3 3785877810 Calystegia pulchra Brumm. & Heyw…  (-2.541045 52.5979)      210. \n4 3352641836 Calystegia pulchra Brumm. & Heyw… (-6.189535 57.41207)       56.7\n5 3338086543 Calystegia pulchra Brumm. & Heyw… (-2.302697 53.20301)      118. \n```\n:::\n:::\n\n\n### Copernicus data\n\nThe original EU-DEM v1.0 (or v1.1) data can be accessed from [copernicus.eu](https://land.copernicus.eu/imagery-in-situ/eu-dem) portal. It's divided in 10x10 degree tiles, which results in quite huge files (up to 5 GB per tile). The similar data set, in smaller tiles is available from [AWS Opendata Registry](https://registry.opendata.aws/copernicus-dem/). Details in [readme](https://copernicus-dem-30m.s3.amazonaws.com/readme.html). This set can be downloaded by `CopernicusDEM` package [@R-CopernicusDEM]. Please note, that this dataset is a Digital Surface Model, where elevation measurements represent the surface of the Earth including buildings and infrastructure.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(CopernicusDEM)\n\npolygon <- sf::st_as_sf(uk)\nsf::sf_use_s2(use_s2 = FALSE)\n\nif(!dir.exists(\"data/copernicus\")) { dir.create(\"data/copernicus\")}\n\naoi_geom_save_tif_matches(\n  sf_or_file = polygon,\n  dir_save_tifs = \"data/copernicus\",\n  resolution = 30,\n  crs_value = 4326,\n  threads = parallel::detectCores(),\n  verbose = TRUE\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nr <- list.files(path = \"data/copernicus/\", pattern = \"Copernicus_.+.tif\", full.names = TRUE)\ncop <- terra::vrt(r, \"data/copernicus/vrt.vrt\", overwrite = TRUE) \n\nocc |>\n  dplyr::mutate(ele_cop = terra::extract(cop, terra::vect(geometry))$vrt) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -6.189535 ymin: 51.49552 xmax: -0.17902 ymax: 57.41207\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 4\n  key        scientificName                                geometry ele_cop\n  <chr>      <chr>                                      <POINT [°]>   <dbl>\n1 3320924569 Calystegia pulchra Brumm. & Heyw…  (-0.17902 51.49553)    9.39\n2 3437494613 Calystegia pulchra Brumm. & Heyw… (-1.962333 51.78564)  218.  \n3 3785877810 Calystegia pulchra Brumm. & Heyw…  (-2.541045 52.5979)  157.  \n4 3352641836 Calystegia pulchra Brumm. & Heyw… (-6.189535 57.41207)    0   \n5 3338086543 Calystegia pulchra Brumm. & Heyw… (-2.302697 53.20301)   70.0 \n```\n:::\n:::\n\n\n### ElevatR - the black horse\n\nAs the name suggests, `elevatr` is a package [@R-elevatr] to access elevation data from various sources. With `get_elev_point()` function obtaining the elevation is as simple as:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nocc |>\n  dplyr::mutate(ele_aws = elevatr::get_elev_point(geometry, src = \"aws\")$elevation) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nMosaicing & Projecting\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nNote: Elevation units are in meters\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -6.189535 ymin: 51.49552 xmax: -0.17902 ymax: 57.41207\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 4\n  key        scientificName                                geometry ele_aws\n  <chr>      <chr>                                      <POINT [°]>   <dbl>\n1 3320924569 Calystegia pulchra Brumm. & Heyw…  (-0.17902 51.49553)      15\n2 3437494613 Calystegia pulchra Brumm. & Heyw… (-1.962333 51.78564)     191\n3 3785877810 Calystegia pulchra Brumm. & Heyw…  (-2.541045 52.5979)     169\n4 3352641836 Calystegia pulchra Brumm. & Heyw… (-6.189535 57.41207)      44\n5 3338086543 Calystegia pulchra Brumm. & Heyw… (-2.302697 53.20301)      75\n```\n:::\n:::\n\n\nTBC...\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}